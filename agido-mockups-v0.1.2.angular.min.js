/*! agido-mockups v0.1.2 2013-11-15 http://itcrowd.pl by IT Crowd @it-crowd - MIT License https://github.com/it-crowd/agido-mockups/wiki/License*/
var agidoMockups=angular.module("AgidoMockups",[]);agidoMockups.controller("EditorCtrl",["$scope","$timeout","$window",function(a,b,c){function d(){for(a.exportToJSON(),i.push(a.stageSource),j.length=0;i.length>30;)i.shift()}function e(b,c){c&&d(),void 0==b.attrs.x&&b.setX((a.stage.getWidth()-b.getWidth())/2),void 0==b.attrs.y&&b.setY((a.stage.getHeight()-b.getHeight())/2),a.stage.add(b)}function f(b){return null!=a.selectedComponent&&null!=b&&""!=b.trim()?(d(),a.selectedComponent.setText(b),a.stage.draw(),!0):!1}function g(a){for(var b=JSON.parse(a),c=0;c<b.length;c++){var d=Kinetic.Node.create(JSON.stringify(b[c]));d.mockupComponent=n[d.attrs.componentName],e(d)}}a.selectedComponent=null,a.editingSource=!1;var h,i=[],j=[],k=a.availableFonts=["Arial","Bigelow Rules","Georgia","Cherry Swash","Comic Sans MS","Helvetica","Lucida Console","Prosto One","Stint Ultra Expanded","Times New Roman"],l=[{name:"x",hidden:!0},{name:"y",hidden:!0},{name:"width",hidden:!0},{name:"height",hidden:!0}],m=[{name:"fontFamily",type:"enum",options:k},{name:"fontSize",type:"number",min:8},{name:"fontStyle",type:"enum",options:["normal","bold","italic"]}],n={Arrow:{constructor:Kinetic.Arrow,options:{stroke:"#000",draggable:!0,width:200,height:50},hasText:!1,properties:l.concat([{name:"leftDown",type:"boolean"}])},Checkbox:{constructor:Kinetic.Checkbox,options:{color:"#000",draggable:!0},multilineSource:!1,resizable:!1,properties:m.concat(l,[{name:"selected",type:"boolean"},{name:"disabled",type:"boolean"}])},CheckboxGroup:{constructor:Kinetic.CheckboxGroup,options:{color:"#000",draggable:!0},multilineSource:!0,resizable:!1,properties:m.concat(l)},Label:{constructor:Kinetic.Text,options:{text:"Label",fill:"#000",draggable:!0},multilineSource:!1,resizable:!1,properties:m.concat(l)},Title:{constructor:Kinetic.Text,options:{fontSize:48,text:"Title",fill:"#000",draggable:!0},multilineSource:!1,resizable:!1,properties:m.concat(l)},Subtitle:{constructor:Kinetic.Text,options:{fontSize:32,text:"Subtitle",fill:"#000",draggable:!0},multilineSource:!1,resizable:!1,properties:m.concat(l)},Link:{constructor:Kinetic.Link,options:{color:"#5df",draggable:!0},multilineSource:!1,resizable:!1,properties:m.concat(l,[{name:"disabled",type:"boolean"}])},Panel:{constructor:Kinetic.Panel,options:{draggable:!0},multilineSource:!1,properties:l},Paragraph:{constructor:Kinetic.Paragraph,options:{draggable:!0},multilineSource:!0,resizable:!1,properties:[{name:"fontFamily",type:"enum",options:k},{name:"fontSize",type:"number",min:8}].concat(l)},Pagination:{constructor:Kinetic.Pagination,options:{draggable:!0},hasText:!1,resizable:!1,properties:l},RadioItem:{constructor:Kinetic.RadioItem,options:{color:"#000",draggable:!0},multilineSource:!1,resizable:!1,properties:m.concat(l,[{name:"selected",type:"boolean"},{name:"disabled",type:"boolean"}])},RadioGroup:{constructor:Kinetic.RadioGroup,options:{color:"#000",draggable:!0},multilineSource:!0,resizable:!1,properties:m.concat(l)},Input:{constructor:Kinetic.Input,options:{color:"#000",draggable:!0},multilineSource:!1,properties:m.concat(l,[{name:"disabled",type:"boolean"}])},TextArea:{constructor:Kinetic.TextArea,options:{color:"#000",draggable:!0},multilineSource:!0,properties:m.concat(l,[{name:"disabled",type:"boolean"}])},Button:{constructor:Kinetic.Button,options:{color:"#000",draggable:!0},multilineSource:!1,properties:m.concat(l,[{name:"disabled",type:"boolean"}])},Comment:{constructor:Kinetic.Comment,options:{color:"#000",draggable:!0},multilineSource:!0,properties:m.concat(l)},Select:{constructor:Kinetic.Select,options:{color:"#000",draggable:!0},multilineSource:!0,properties:m.concat(l,[{name:"disabled",type:"boolean"},{name:"opened",type:"boolean"}])},Window:{constructor:Kinetic.Window,options:{draggable:!0},multilineSource:!0,properties:l},Datepicker:{constructor:Kinetic.Datepicker,options:{color:"#000",draggable:!0},multilineSource:!1,properties:m.concat(l,[{name:"disabled",type:"boolean"},{name:"inline",type:"boolean"}])},ImageItem:{constructor:Kinetic.ImageItem,options:{draggable:!0},multilineSource:!1,properties:l},MenuBar:{constructor:Kinetic.MenuBar,options:{draggable:!0},multilineSource:!1,properties:m.concat(l)},Table:{constructor:Kinetic.Table,options:{draggable:!0},multilineSource:!0,properties:m.concat(l,[{name:"showHeader",type:"boolean"},{name:"padding",type:"number"}])},Menu:{constructor:Kinetic.Menu,options:{draggable:!0},multilineSource:!0,resizable:!1,properties:m.concat(l)},RichEditor:{constructor:Kinetic.RichEditor,options:{color:"#000",draggable:!0},multilineSource:!0,properties:m.concat(l,[{name:"disabled",type:"boolean"}])},ColorPicker:{constructor:Kinetic.ColorPicker,options:{color:"red",draggable:!0},noSource:!0,properties:l.concat([{name:"disabled",type:"boolean"}])},ModalOverlay:{constructor:Kinetic.ModalOverlay,options:{draggable:!0},noSource:!0,properties:l},NumericStepper:{constructor:Kinetic.NumericStepper,options:{color:"#000",draggable:!0},multilineSource:!1,properties:m.concat(l,[{name:"disabled",type:"boolean"}])},FieldSet:{constructor:Kinetic.FieldSet,options:{draggable:!0},multilineSource:!1,properties:l},HorizontalRule:{constructor:Kinetic.HorizontalRule,options:{color:"#000",draggable:!0},noSource:!0,properties:l},VerticalRule:{constructor:Kinetic.VerticalRule,options:{color:"#000",draggable:!0},noSource:!0,properties:l},VerticalScrollBar:{constructor:Kinetic.VerticalScrollBar,options:{draggable:!0},noSource:!0,properties:l},HorizontalScrollBar:{constructor:Kinetic.HorizontalScrollBar,options:{draggable:!0},noSource:!0,properties:l}};for(var o in n)n.hasOwnProperty(o)&&(n[o].options.componentName=o);a.addToStage=function(c){var d=n[c];if(null==d)throw new Error("Unsupported type: "+c);var f=new d.constructor(d.options);f.mockupComponent=d,e(f,!0),b(function(){a.editingSource=!0})},a.addToStageFromSearch=function(b){a.addToStage(b.value)},a.search=function(a,b){var c=[],d=a.term.toLowerCase();for(var e in n)n.hasOwnProperty(e)&&e.toLowerCase().indexOf(d)>-1&&c.push(e);b(c)},a.saveSource=function(a){return f(a)},a.mockupComponentSelected=function(b){if(a.selectedComponent=b,a.selectedComponentProperties={},null!=b)for(var c=b.mockupComponent.properties,e=0;null!=c&&e<c.length;e++){var f=c[e];a.selectedComponentProperties.__defineGetter__(f.name,function(b){return null==a.selectedComponent?null:a.selectedComponent["get"+Kinetic.Util._capitalize(b)]()}.bind(null,f.name)),a.selectedComponentProperties.__defineSetter__(f.name,function(b,c){if(null!=a.selectedComponent){if("number"==b.type&&b.min&&b.min>c)return;d(),a.selectedComponent["set"+Kinetic.Util._capitalize(b.name)](c)}a.stage.draw()}.bind(null,f))}},a.mockupComponentGroupSelected=function(b){a.selectedComponent=null,a.selectedComponentProperties={},a.selectedComponentGroup=b,a.editingSource=!1},a.stageClicked=function(b){null!=a.selectedComponent&&(a.selectedComponent.mockupComponent.multilineSource&&f(b),a.selectedComponent=null,a.editingSource=!1)},a.isComponentResizable=function(a){return a.mockupComponent.resizable!==!1},a.isMockupComponent=function(a){return null!=a.mockupComponent},a.hasSource=function(a){return null!=a.mockupComponent&&!(a.mockupComponent.hasText===!1)},a.downloadImage=function(){a.stage.toDataURL({callback:function(a){var b=document.createElement("a");b.setAttribute("href",a.replace(/^data:image\/[^;]/,"data:application/octet-stream")),b.setAttribute("download","AgidoMockup.png"),b.setAttribute("style","display:none"),document.body.appendChild(b),b.click(),document.body.removeChild(b)}})},a.importJSON=function(a){d(),g(a)},a.exportToJSON=function(){a.stageSource=a.stage.toJSON()},a.toggleGrid=function(){a.stage.toggleGrid()},a.toggleSnapToGrid=function(){a.stage.toggleSnapToGrid()},a.decreaseGridDensity=function(){a.stage.decreaseGridDensity()},a.increaseGridDensity=function(){a.stage.increaseGridDensity()},a.getComponentType=function(a){return null==a?null:a.className},a.getProperties=function(a){return null==a?null:a.mockupComponent.properties},a.undo=function(){i.length>0&&(a.exportToJSON(),j.push(a.stageSource),a.stage.clear(),g(i.pop()))},a.isUndoAvailable=function(){return i.length>0},a.redo=function(){j.length>0&&(a.exportToJSON(),i.push(a.stageSource),a.stage.clear(),g(j.pop()))},a.isRedoAvailable=function(){return j.length>0},a.duplicate=function(){if(null!=a.selectedComponent){var b=new a.selectedComponent.mockupComponent.constructor(a.selectedComponent.attrs),c=a.selectedComponent.getParent();if(c instanceof Kinetic.Layer)b.setX(b.getX()+15),b.setY(b.getY()+15);else{var d=void 0==c?a.selectedComponent:c;b.setX(d.getX()+15),b.setY(d.getY()+15)}b.mockupComponent=a.selectedComponent.mockupComponent,a.selectedComponent=b,e(b,!0)}},a.cut=function(){null!=a.selectedComponent&&(d(),h=a.selectedComponent,h.remove(),a.selectedComponent=null,a.editingSource=!1,a.stage.draw())},a.isClipboardEmpty=function(){return null==h},a.paste=function(){null!=h&&(a.selectedComponent=h,a.duplicate())},a.delete=function(){if(null!=a.selectedComponent)d(),a.selectedComponent.getParent()instanceof Kinetic.Layer?a.selectedComponent.destroy():a.selectedComponent.getParent().destroy(),a.selectedComponent=null,a.editingSource=!1,a.stage.draw();else if(null!=a.selectedComponentGroup){var b=a.selectedComponentGroup.getChildren().toArray();d(),Kinetic.Collection.toCollection(b).each(function(a){a.destroy()}),a.selectedComponentGroup.destroy(),a.selectedComponentGroup=null,a.editingSource=!1,a.stage.draw()}},a.clearStage=function(){c.confirm("Are you sure you want to clear stage?")&&(d(),a.stage.clear())},a.lock=function(){alert("Not implemented yet")},a.$on("AgidoMockups.sourceReady",function(b,c){a.importJSON(c)}),a.save=function(){a.exportToJSON(),a.$emit("AgidoMockups.save",a.stageSource),a.stage.toDataURL({callback:function(b){a.$emit("AgidoMockups.saveImage",b)}})},a.moveToTop=function(){null!=a.selectedComponent&&(d(),a.selectedComponent.getParent().moveToTop(),a.stage.draw())},a.moveUp=function(){null!=a.selectedComponent&&(d(),a.selectedComponent.getParent().moveUp(),a.stage.draw())},a.moveDown=function(){null!=a.selectedComponent&&(d(),a.selectedComponent.getParent().moveDown(),a.stage.draw())},a.moveToBottom=function(){null!=a.selectedComponent&&(d(),a.selectedComponent.getParent().moveToBottom(),a.stage.draw())}}]),agidoMockups.directive("suggest",["$timeout",function(a){return{restrict:"A",scope:!1,link:function(b,c,d){c.autocomplete({source:b[d.suggest],select:function(e,f){return a(function(){c.val("");var a=d.suggestSelect,e=b[a];if(e instanceof Function)e(f.item);else if(void 0!=a)throw new Error("Method "+a+" not found in scope")},0),!1}})}}}]),agidoMockups.directive("stage",["$timeout","$window",function(a,b){function c(a,b){for(var c=a.targetNode;null!=c.getParent();){if(b({component:c}))return c;c=c.getParent()}return b({component:c})?c:null}function d(a){a.cancelBubble=!0}function e(a){return!0===a.attrs.selectionGroup||a.attrs.resizeAnchor===!0||"editorSelectionBorder"==a.attrs.name}function f(a){if(a instanceof Kinetic.Group&&a.attrs.selectionGroup===!0){for(var b=[],c=a.getZIndex();a.getChildren().length>0;){var d=a.getChildren()[0];e(d)?d.destroy():(d.remove(),d.setX((d.getX()||0)+a.getX()),d.setY((d.getY()||0)+a.getY()),d.setAttr("draggable",!0),a.getParent().add(d),b.push(d),d.originalZIndex=Math.max(0,d.originalZIndex+c-a.originalZIndex))}a.destroy(),Kinetic.Collection.toCollection(b).each(function(a){a.setZIndex(a.originalZIndex),delete a.originalZIndex})}}function g(b,c,d,e){function g(a){b.setWidth(a.layerX-j),b.setHeight(a.layerY-k),l.draw()}function i(){m.off("mousemove"),m.off("mouseup"),b.off("mousemove"),b.off("mouseup"),c.getChildren().each(f);var e,g=b.getX(),i=b.getY(),j=g+b.getWidth(),k=i+b.getHeight();g>j&&(e=j,j=g,g=e),i>k&&(e=k,k=i,i=e);var n=void 0,o=void 0,p=void 0,q=void 0,r=[];if(c.getChildren().each(function(a){var b=a.getX(),c=a.getY(),d=b+a.getWidth(),e=c+a.getHeight();b>=g&&j>=b&&c>=i&&k>=c&&d>=g&&j>=d&&e>=i&&k>=e&&(r.push(a),(void 0==n||n>b)&&(n=b),(void 0==o||o>c)&&(o=c),(void 0==p||d>p)&&(p=d),(void 0==q||e>q)&&(q=e))}),1==r.length)h(r[0],d({component:r[0]}));else if(void 0!=n&&void 0!=o&&void 0!=p&&void 0!=q){var s=new Kinetic.Group({draggable:!0,x:n,y:o,selectionGroup:!0}),t=Kinetic.Collection.toCollection(r);t.each(function(a){a.originalZIndex=a.getZIndex()}),t.each(function(a){a.remove(),a.setAttr("draggable",!1),a.setX(a.getX()-n),a.setY(a.getY()-o),s.add(a)}),s.add(b.clone({x:0,y:0,width:p-n,height:q-o,draggable:!1,name:"editorSelectionBorder"})),c.add(s),s.originalZIndex=s.getZIndex(),c.fire("nodeGroupSelected",s,!0)}b.hide(),l.getParent().draw(),a(function(){})}var j=e.layerX,k=e.layerY,l=b.getLayer(),m=b.getStage();b.setX(j),b.setY(k),b.setWidth(0),b.setHeight(0),b.show(),m.on("mousemove",g),b.on("mousemove",g),m.on("mouseup",i),b.on("mouseup",i)}function h(a,c){function e(a){var b=a.getParent(),c=b.get(".topLeft")[0],d=b.get(".topRight")[0],e=b.get(".bottomRight")[0],f=b.get(".bottomLeft")[0],g=a.getX(),h=a.getY();switch(a.getName()){case"topLeft":d.setY(h),f.setX(g);break;case"topRight":c.setY(h),e.setX(g);break;case"bottomRight":f.setY(h),d.setX(g);break;case"bottomLeft":e.setY(h),c.setX(g)}b.mainComponent.setPosition(c.getPosition());var i=b.find(".editorSelectionBorder")[0];i.setPosition(c.getPosition());var j=d.getX()-c.getX(),k=f.getY()-c.getY();j&&k&&(b.mainComponent.setSize(j,k),i.setSize(j,k)),b.getStage().draw()}function g(a,c,d,f){var g=a.getLayer(),h=new Kinetic.Circle({x:c,y:d,stroke:"#777",fill:"#ddd",strokeWidth:2,radius:8,name:f,draggable:!0,dragOnTop:!1,resizeAnchor:!0});h.on("dragmove",function(){e(this),g.draw()}),h.on("mousedown touchstart",function(){a.setDraggable(!1),this.moveToTop()}),h.on("dragend",function(){a.setDraggable(!0),g.draw()}),h.on("mouseover",function(){var a=this.getLayer();b.document.body.style.cursor="pointer",this.setStrokeWidth(4),a.draw()}),h.on("mouseout",function(){var a=this.getLayer();b.document.body.style.cursor="default",this.setStrokeWidth(2),a.draw()}),a.add(h)}var h=a.getLayer();if(h.getChildren().each(f),!(a.getParent()instanceof Kinetic.Group)){var i=new Kinetic.Group({draggable:!0,x:a.getX(),y:a.getY(),selectionGroup:!0});i.mainComponent=a,a.originalZIndex=a.getZIndex(),a.remove(),a.setAttr("draggable",!1),a.setX(0),a.setY(0),i.add(a),h.add(i),i.setZIndex(a.originalZIndex),i.originalZIndex=i.getZIndex(),c&&(g(i,0,0,"topLeft"),g(i,a.getWidth(),0,"topRight"),g(i,a.getWidth(),a.getHeight(),"bottomRight"),g(i,0,a.getHeight(),"bottomLeft"));var j=new Kinetic.Rect({name:"editorSelectionBorder",stroke:"#f00",width:a.getWidth(),height:a.getHeight()});i.add(j),j.on("click",function(b){d(b),a.fire("click",{targetNode:a},!0)}),j.on("dblclick",function(b){d(b),a.fire("dblclick",{targetNode:a},!0)})}h.draw(),a.fire("nodeSelected",a,!0)}return{restrict:"E",scope:{stage:"=",editingSource:"=",hasText:"&",isMockupComponent:"&",isComponentResizable:"&",saveSource:"&",stageClicked:"&",mockupComponentSelected:"&",mockupComponentGroupSelected:"&",selectedComponent:"="},template:'<div class="stageContainer"><div class="stage"></div><form ng-submit = "saveSource()" ng-hide="selectedComponent.mockupComponent.noSource"><input type="text" ng-model="componentSource" ng-show="editingSource && !selectedComponent.mockupComponent.multilineSource" class="form-control" ng-style="editorStyle" ng-keyup="onComponentSourceKeyPress($event)"/><textarea ng-model="componentSource" ng-show="editingSource && selectedComponent.mockupComponent.multilineSource" class="form-control" ng-style="editorStyle" ng-keyup="onComponentSourceKeyPress($event)" rows="5" cols="50"></textarea></form></div>',replace:!0,link:function(f,i){function j(){var a=p.getSpacing();this.setX(parseInt(this.attrs.x/a)*a),this.setY(parseInt(this.attrs.y/a)*a)}var k=new Kinetic.Stage({container:i[0].firstChild,width:b.document.body.offsetWidth,height:700}),l=angular.element(i[0].firstChild),m=f.$apply.bind(f,function(){k.setWidth(b.document.body.offsetWidth),p.setSize(k.getWidth(),k.getHeight())});angular.element(b).bind("resize",m),f.$on("$destroy",function(){angular.element(b).unbind("resize",m)});var n=new Kinetic.Layer({});k.add(n);var o=new Kinetic.Rect({fill:"#fff",width:k.getWidth(),height:k.getHeight()});n.add(o);var p=new Kinetic.Grid({width:k.getWidth(),height:k.getHeight(),stroke:"#00f",strokeWidth:.5,opacity:.2});n.add(p);var q=new Kinetic.Layer({name:"componentsLayer"});k.add(q);var r=new Kinetic.Layer({});k.add(r);var s=new Kinetic.Rect({stroke:"#f00",draggable:!0,visible:!1});r.add(s),k.draw(),o.on("mousedown",g.bind(null,s,q,f.isComponentResizable));var t=i.find("textarea"),u=i.find("input");t.bind("click",d),u.bind("click",d),f.$watch("editingSource && selectedComponent.mockupComponent.multilineSource",function(a){a&&(t[0].focus(),t[0].select(t[0]))},!0),f.$watch("editingSource && !selectedComponent.mockupComponent.multilineSource",function(a){a&&(u[0].focus(),u[0].select(u[0]))},!0),k.on("click",function(a){var b=c(a,f.isMockupComponent);null!=b?b!=f.selectedComponent&&h(b,f.isComponentResizable({component:b})):(f.editingSource=!1,f.stageClicked({source:f.componentSource})),f.$apply()}),k.on("nodeSelected",function(a){f.mockupComponentSelected({component:a}),f.editorStyle={position:"absolute",top:l.offset().top+a.getParent().getY()+"px",left:a.getParent().getX()+"px"},f.editingSource=!1,f.hasText({component:a})&&(f.componentSource=a.getText())}),k.on("dblclick",function(){var b=f.selectedComponent;null!=b&&(f.editingSource=!0,a(function(){b.mockupComponent.multilineSource?(t[0].focus(),t[0].select(t[0])):(u[0].focus(),u[0].select(u[0]))}))}),k.on("nodeGroupSelected",function(a){f.mockupComponentGroupSelected({component:a})});var v=13,w=27;f.onComponentSourceKeyPress=function(a){v==a.keyCode?null==f.selectedComponent||f.selectedComponent.mockupComponent.multilineSource||f.saveSource({source:f.componentSource})&&(f.editingSource=!1):w==a.keyCode&&(f.editingSource=!1)};var x=!1;q.on("add",function(a){x&&a.child.on("dragmove.snapToGrid",j)}),f.stage={getHeight:k.getHeight.bind(k),getWidth:k.getWidth.bind(k),draw:k.draw.bind(k),add:function(a){q.add(a),h(a,f.isComponentResizable({component:a}))},clear:function(){f.editingSource=!1,q.destroyChildren(),q.draw()},toggleGrid:function(){p.isVisible()?p.hide():p.show(),p.getLayer().draw()},toggleSnapToGrid:function(){x=!x,q.getChildren().each(function(a){x?a.on("dragmove.snapToGrid",j):a.off("dragmove.snapToGrid")})},decreaseGridDensity:function(){p.setSpacing(2*p.getSpacing()),p.getLayer().draw()},increaseGridDensity:function(){p.setSpacing(Math.max(5,p.getSpacing()/2)),p.getLayer().draw()},toDataURL:k.toDataURL.bind(k),toJSON:function(){var a=[],b=new Kinetic.Collection;return q.getChildren().each(function(c){if(e(c)){var d=c.getX(),f=c.getY();c.getChildren().each(function(a){if(!e(a)){var c=a.toObject();c.attrs.x=(c.attrs.x||0)+d,c.attrs.y=(c.attrs.y||0)+f,c.originalZIndex=a.originalZIndex,b.push(c)}})}else a.push(c.toObject())}),b.each(function(b){a.splice(b.originalZIndex,0,b),delete b.originalZIndex}),JSON.stringify(a)},select:function(a){h(a,f.isComponentResizable({component:a}))}}}}}]);