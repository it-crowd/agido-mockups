/*! agido-mockups v0.1.0 2013-11-05 http://itcrowd.pl by IT Crowd @it-crowd - MIT License https://github.com/it-crowd/agido-mockups/wiki/License*/
var agidoMockups=angular.module("AgidoMockups",["ui.bootstrap"],null);agidoMockups.controller("EditorCtrl",["$scope","$window",function(a,b){function c(){var b=a.selectedComponent;for(a.exportToJSON(),g.push(a.stageSource),h.length=0;g.length>30;)g.shift();void 0!=b&&a.stage.select(b)}function d(b,d){d&&c(),void 0==b.attrs.x&&b.setX((a.stage.getWidth()-b.getWidth())/2),void 0==b.attrs.y&&b.setY((a.stage.getHeight()-b.getHeight())/2),a.stage.add(b)}function e(b){return null!=a.selectedComponent&&null!=b&&""!=b.trim()?(c(),a.selectedComponent.setText(b),a.stage.draw(),!0):!1}a.selectedComponent=null,a.editingSource=!1;var f,g=[],h=[],i=a.availableFonts=["Arial","Bigelow Rules","Georgia","Cherry Swash","Comic Sans MS","Helvetica","Lucida Console","Prosto One","Stint Ultra Expanded","Times New Roman"],j=[{name:"x",hidden:!0},{name:"y",hidden:!0},{name:"width",hidden:!0},{name:"height",hidden:!0}],k=[{name:"fontFamily",type:"enum",options:i},{name:"fontSize",type:"number",min:8},{name:"fontStyle",type:"enum",options:["normal","bold","italic"]}],l={Arrow:{constructor:Kinetic.Arrow,options:{stroke:"#000",draggable:!0,width:200,height:50},hasText:!1,properties:j.concat([{name:"leftDown",type:"boolean"}])},Checkbox:{constructor:Kinetic.Checkbox,options:{color:"#000",draggable:!0},multilineSource:!1,resizable:!1,properties:k.concat(j,[{name:"selected",type:"boolean"},{name:"disabled",type:"boolean"}])},CheckboxGroup:{constructor:Kinetic.CheckboxGroup,options:{color:"#000",draggable:!0},multilineSource:!0,resizable:!1,properties:k.concat(j)},Label:{constructor:Kinetic.Text,options:{text:"Label",fill:"#000",draggable:!0},multilineSource:!1,resizable:!1,properties:k.concat(j)},Title:{constructor:Kinetic.Text,options:{fontSize:48,text:"Title",fill:"#000",draggable:!0},multilineSource:!1,resizable:!1,properties:k.concat(j)},Subtitle:{constructor:Kinetic.Text,options:{fontSize:32,text:"Subtitle",fill:"#000",draggable:!0},multilineSource:!1,resizable:!1,properties:k.concat(j)},Link:{constructor:Kinetic.Link,options:{color:"#5df",draggable:!0},multilineSource:!1,resizable:!1,properties:k.concat(j,[{name:"disabled",type:"boolean"}])},Panel:{constructor:Kinetic.Panel,options:{draggable:!0},multilineSource:!1,properties:j},Paragraph:{constructor:Kinetic.Paragraph,options:{draggable:!0},multilineSource:!0,resizable:!1,properties:[{name:"fontFamily",type:"enum",options:i},{name:"fontSize",type:"number",min:8}].concat(j)},Pagination:{constructor:Kinetic.Pagination,options:{draggable:!0},hasText:!1,resizable:!1,properties:j},RadioItem:{constructor:Kinetic.RadioItem,options:{color:"#000",draggable:!0},multilineSource:!1,resizable:!1,properties:k.concat(j,[{name:"selected",type:"boolean"},{name:"disabled",type:"boolean"}])},RadioGroup:{constructor:Kinetic.RadioGroup,options:{color:"#000",draggable:!0},multilineSource:!0,resizable:!1,properties:k.concat(j)},Input:{constructor:Kinetic.Input,options:{color:"#000",draggable:!0},multilineSource:!1,properties:k.concat(j,[{name:"disabled",type:"boolean"}])},TextArea:{constructor:Kinetic.TextArea,options:{color:"#000",draggable:!0},multilineSource:!0,properties:k.concat(j,[{name:"disabled",type:"boolean"}])},Button:{constructor:Kinetic.Button,options:{color:"#000",draggable:!0},multilineSource:!1,properties:k.concat(j,[{name:"disabled",type:"boolean"}])},Comment:{constructor:Kinetic.Comment,options:{color:"#000",draggable:!0},multilineSource:!0,properties:k.concat(j)},Select:{constructor:Kinetic.Select,options:{color:"#000",draggable:!0},multilineSource:!0,properties:k.concat(j,[{name:"disabled",type:"boolean"},{name:"opened",type:"boolean"}])},Window:{constructor:Kinetic.Window,options:{draggable:!0},multilineSource:!0,properties:j},Datepicker:{constructor:Kinetic.Datepicker,options:{color:"#000",draggable:!0},multilineSource:!1,properties:k.concat(j,[{name:"disabled",type:"boolean"},{name:"inline",type:"boolean"}])},ImageItem:{constructor:Kinetic.ImageItem,options:{draggable:!0},multilineSource:!1,properties:j},MenuBar:{constructor:Kinetic.MenuBar,options:{draggable:!0},multilineSource:!1,properties:k.concat(j)},Table:{constructor:Kinetic.Table,options:{draggable:!0},multilineSource:!0,properties:k.concat(j,[{name:"showHeader",type:"boolean"},{name:"padding",type:"number"}])},Menu:{constructor:Kinetic.Menu,options:{draggable:!0},multilineSource:!0,resizable:!1,properties:k.concat(j)}};for(var m in l)l.hasOwnProperty(m)&&(l[m].options.componentName=m);a.addToStage=function(a){var b=l[a];if(null==b)throw new Error("Unsupported type: "+a);var c=new b.constructor(b.options);c.mockupComponent=b,d(c,!0)},a.saveSource=function(a){return e(a)},a.mockupComponentSelected=function(b){if(a.selectedComponent=b,a.selectedComponentProperties={},null!=b)for(var d=b.mockupComponent.properties,e=0;null!=d&&e<d.length;e++){var f=d[e];a.selectedComponentProperties.__defineGetter__(f.name,function(b){return null==a.selectedComponent?null:a.selectedComponent["get"+Kinetic.Util._capitalize(b)]()}.bind(null,f.name)),a.selectedComponentProperties.__defineSetter__(f.name,function(b,d){if(null!=a.selectedComponent){if("number"==b.type&&b.min&&b.min>d)return;c(),a.selectedComponent["set"+Kinetic.Util._capitalize(b.name)](d)}a.stage.draw()}.bind(null,f))}},a.stageClicked=function(b){null!=a.selectedComponent&&(a.selectedComponent.mockupComponent.multilineSource&&e(b),a.selectedComponent=null)},a.isComponentResizable=function(a){return a.mockupComponent.resizable!==!1},a.isMockupComponent=function(a){return null!=a.mockupComponent},a.hasSource=function(a){return null!=a.mockupComponent&&!(a.mockupComponent.hasText===!1)},a.downloadImage=function(){a.stage.toDataURL({callback:function(a){var b=document.createElement("a");b.setAttribute("href",a),b.setAttribute("download","AgidoMockup.png"),b.click()}})},a.importJSON=function(a){for(var b=JSON.parse(a),c=0;c<b.length;c++){var e=Kinetic.Node.create(JSON.stringify(b[c]));e.mockupComponent=l[e.attrs.componentName],d(e)}},a.exportToJSON=function(){a.stage.unselectAll(),a.stageSource=a.stage.toJSON()},a.toggleGrid=function(){a.stage.toggleGrid()},a.toggleSnapToGrid=function(){a.stage.toggleSnapToGrid()},a.decreaseGridDensity=function(){a.stage.decreaseGridDensity()},a.increaseGridDensity=function(){a.stage.increaseGridDensity()},a.getComponentType=function(a){return null==a?null:a.className},a.getProperties=function(a){return null==a?null:a.mockupComponent.properties},a.undo=function(){g.length>0&&(a.exportToJSON(),h.push(a.stageSource),a.stage.clear(),a.importJSON(g.pop()))},a.isUndoAvailable=function(){return g.length>0},a.redo=function(){h.length>0&&(a.exportToJSON(),g.push(a.stageSource),a.stage.clear(),a.importJSON(h.pop()))},a.isRedoAvailable=function(){return h.length>0},a.duplicate=function(){if(null!=a.selectedComponent){var b=new a.selectedComponent.mockupComponent.constructor(a.selectedComponent.attrs);a.selectedComponent.getParent()instanceof Kinetic.Layer?(b.setX(b.getX()+15),b.setY(b.getY()+15)):(b.setX(a.selectedComponent.getParent().getX()+15),b.setY(a.selectedComponent.getParent().getY()+15)),b.mockupComponent=a.selectedComponent.mockupComponent,a.selectedComponent=b,d(b,!0)}},a.cut=function(){null!=a.selectedComponent&&(c(),f=a.selectedComponent,f.remove(),a.selectedComponent=null,a.editingSource=!1,a.stage.draw())},a.isClipboardEmpty=function(){return null==f},a.paste=function(){null!=f&&(a.selectedComponent=f,a.duplicate())},a.delete=function(){null!=a.selectedComponent&&(c(),a.selectedComponent.getParent()instanceof Kinetic.Layer?a.selectedComponent.destroy():a.selectedComponent.getParent().destroy(),a.selectedComponent=null,a.editingSource=!1,a.stage.draw())},a.clearStage=function(){b.confirm("Are you sure you want to clear stage?")&&(c(),a.stage.clear())},a.lock=function(){alert("Not implemented yet")},a.moveToTop=function(){null!=a.selectedComponent&&(c(),a.selectedComponent.getParent().moveToTop(),a.stage.draw())},a.moveUp=function(){null!=a.selectedComponent&&(c(),a.selectedComponent.getParent().moveUp(),a.stage.draw())},a.moveDown=function(){null!=a.selectedComponent&&(c(),a.selectedComponent.getParent().moveDown(),a.stage.draw())},a.moveToBottom=function(){null!=a.selectedComponent&&(c(),a.selectedComponent.getParent().moveToBottom(),a.stage.draw())}}]),agidoMockups.directive("stage",["$timeout","$window",function(a,b){function c(a,b){for(var c=a.targetNode;null!=c.getParent();){if(b({component:c}))return c;c=c.getParent()}return b({component:c})?c:null}function d(a){a.cancelBubble=!0}function e(a){if(a instanceof Kinetic.Group&&a.attrs.selectionGroup===!0){for(var b=[],c=a.getZIndex();a.getChildren().length>0;){var d=a.getChildren()[0];d.attrs.selectionBorder===!0||d.attrs.resizeAnchor===!0?d.destroy():(d.remove(),d.setX((d.getX()||0)+a.getX()),d.setY((d.getY()||0)+a.getY()),d.setAttr("draggable",!0),a.getParent().add(d),b.push(d),d.originalZIndex=Math.max(0,d.originalZIndex+c-a.originalZIndex))}a.destroy(),Kinetic.Collection.toCollection(b).each(function(a){a.setZIndex(a.originalZIndex),delete a.originalZIndex})}}function f(b,c,d){function f(a){b.setWidth(a.layerX-i),b.setHeight(a.layerY-j),k.draw()}function h(){l.off("mousemove"),l.off("mouseup"),b.off("mousemove"),b.off("mouseup"),c.getChildren().each(e);var d,f=b.getX(),h=b.getY(),i=f+b.getWidth(),j=h+b.getHeight();f>i&&(d=i,i=f,f=d),h>j&&(d=j,j=h,h=d);var m=void 0,n=void 0,o=void 0,p=void 0,q=[];if(c.getChildren().each(function(a){var b=a.getX(),c=a.getY(),d=b+a.getWidth(),e=c+a.getHeight();b>=f&&i>=b&&c>=h&&j>=c&&d>=f&&i>=d&&e>=h&&j>=e&&(q.push(a),(void 0==m||m>b)&&(m=b),(void 0==n||n>c)&&(n=c),(void 0==o||d>o)&&(o=d),(void 0==p||e>p)&&(p=e))}),1==q.length)g(q[0]);else if(void 0!=m&&void 0!=n&&void 0!=o&&void 0!=p){var r=new Kinetic.Group({draggable:!0,x:m,y:n,selectionGroup:!0}),s=Kinetic.Collection.toCollection(q);s.each(function(a){a.originalZIndex=a.getZIndex()}),s.each(function(a){a.remove(),a.setAttr("draggable",!1),a.setX(a.getX()-m),a.setY(a.getY()-n),r.add(a)}),r.add(b.clone({x:0,y:0,width:o-m,height:p-n,draggable:!1,selectionBorder:!0})),r.originalZIndex=r.getZIndex(),c.add(r)}b.hide(),k.getParent().draw(),a(function(){})}var i=d.layerX,j=d.layerY,k=b.getLayer(),l=b.getStage();b.setX(i),b.setY(j),b.setWidth(0),b.setHeight(0),b.show(),l.on("mousemove",f),b.on("mousemove",f),l.on("mouseup",h),b.on("mouseup",h)}function g(a,c){function d(a){var b=a.getParent(),c=b.get(".topLeft")[0],d=b.get(".topRight")[0],e=b.get(".bottomRight")[0],f=b.get(".bottomLeft")[0],g=a.getX(),h=a.getY();switch(a.getName()){case"topLeft":d.setY(h),f.setX(g);break;case"topRight":c.setY(h),e.setX(g);break;case"bottomRight":f.setY(h),d.setX(g);break;case"bottomLeft":e.setY(h),c.setX(g)}b.mainComponent.setPosition(c.getPosition());var i=d.getX()-c.getX(),j=f.getY()-c.getY();i&&j&&b.mainComponent.setSize(i,j),b.getStage().draw()}function f(a,c,e,f){var g=a.getLayer(),h=new Kinetic.Circle({x:c,y:e,stroke:"#777",fill:"#ddd",strokeWidth:2,radius:8,name:f,draggable:!0,dragOnTop:!1,resizeAnchor:!0});h.on("dragmove",function(){d(this),g.draw()}),h.on("mousedown touchstart",function(){a.setDraggable(!1),this.moveToTop()}),h.on("dragend",function(){a.setDraggable(!0),g.draw()}),h.on("mouseover",function(){var a=this.getLayer();b.document.body.style.cursor="pointer",this.setStrokeWidth(4),a.draw()}),h.on("mouseout",function(){var a=this.getLayer();b.document.body.style.cursor="default",this.setStrokeWidth(2),a.draw()}),a.add(h)}var g=a.getLayer();if(g.getChildren().each(e),!(a.getParent()instanceof Kinetic.Group)){var h=new Kinetic.Group({draggable:!0,x:a.getX(),y:a.getY(),selectionGroup:!0});h.mainComponent=a,a.originalZIndex=a.getZIndex(),a.remove(),a.setAttr("draggable",!1),a.setX(0),a.setY(0),h.add(a),g.add(h),h.setZIndex(a.originalZIndex),h.originalZIndex=h.getZIndex(),c&&(f(h,0,0,"topLeft"),f(h,a.getWidth(),0,"topRight"),f(h,a.getWidth(),a.getHeight(),"bottomRight"),f(h,0,a.getHeight(),"bottomLeft"))}g.draw(),a.fire("nodeSelected",a,!0)}return{restrict:"E",scope:{stage:"=",editingSource:"=",hasText:"&",isMockupComponent:"&",isComponentResizable:"&",saveSource:"&",stageClicked:"&",mockupComponentSelected:"&",selectedComponent:"="},template:'<div class="stageContainer"><div class="stage"></div><form ng-submit = "saveSource()"><input ng-model="componentSource" ng-show="editingSource && !selectedComponent.mockupComponent.multilineSource" ng-style="editorStyle" ng-keyup="onComponentSourceKeyPress($event)"/><textarea ng-model="componentSource" ng-show="editingSource && selectedComponent.mockupComponent.multilineSource" ng-style="editorStyle" ng-keyup="onComponentSourceKeyPress($event)" rows="5" cols="50"></textarea></form></div>',replace:!0,link:function(h,i){function j(){var a=o.getSpacing();this.setX(parseInt(this.attrs.x/a)*a),this.setY(parseInt(this.attrs.y/a)*a)}var k=new Kinetic.Stage({container:i[0].firstChild,width:b.document.body.offsetWidth,height:700}),l=h.$apply.bind(h,function(){k.setWidth(b.document.body.offsetWidth),o.setSize(k.getWidth(),k.getHeight())});angular.element(b).bind("resize",l),h.$on("$destroy",function(){angular.element(b).unbind("resize",l)});var m=new Kinetic.Layer({});k.add(m);var n=new Kinetic.Rect({fill:"#fff",width:k.getWidth(),height:k.getHeight()});m.add(n);var o=new Kinetic.Grid({width:k.getWidth(),height:k.getHeight(),stroke:"#00f",strokeWidth:.5,opacity:.2});m.add(o);var p=new Kinetic.Layer({name:"componentsLayer"});k.add(p);var q=new Kinetic.Layer({});k.add(q);var r=new Kinetic.Rect({stroke:"#f00",draggable:!0,visible:!1});q.add(r),k.draw(),n.on("mousedown",f.bind(null,r,p));var s=i.find("textarea"),t=i.find("input");s.bind("click",d),t.bind("click",d),h.$watch("editingSource && selectedComponent.mockupComponent.multilineSource",function(a){a&&(s[0].focus(),s[0].select(s[0]))},!0),h.$watch("editingSource && !selectedComponent.mockupComponent.multilineSource",function(a){a&&(t[0].focus(),t[0].select(t[0]))},!0),k.on("click",function(a){var b=c(a,h.isMockupComponent);null!=b?g(b,h.isComponentResizable({component:b})):h.editingSource&&(h.editingSource=!1,h.stageClicked({source:h.componentSource})),h.$apply()}),k.on("nodeSelected",function(b){h.mockupComponentSelected({component:b}),h.editorStyle={position:"absolute",top:b.getParent().getY()+"px",left:b.getParent().getX()+"px"},h.hasText({component:b})&&(h.componentSource=b.getText(),a(function(){h.editingSource=!0}))});var u=13,v=27;h.onComponentSourceKeyPress=function(a){u==a.keyCode?null==h.selectedComponent||h.selectedComponent.mockupComponent.multilineSource||h.saveSource({source:h.componentSource})&&(h.editingSource=!1):v==a.keyCode&&(h.editingSource=!1)};var w=!1;p.on("add",function(a){w&&a.child.on("dragmove.snapToGrid",j)}),h.stage={getHeight:k.getHeight.bind(k),getWidth:k.getWidth.bind(k),draw:k.draw.bind(k),add:function(a){p.add(a),g(a,h.isComponentResizable({component:a}))},unselectAll:function(){p.getChildren().each(e),p.draw()},clear:function(){h.editingSource=!1,p.destroyChildren(),p.draw()},toggleGrid:function(){o.isVisible()?o.hide():o.show(),o.getLayer().draw()},toggleSnapToGrid:function(){w=!w,p.getChildren().each(function(a){w?a.on("dragmove.snapToGrid",j):a.off("dragmove.snapToGrid")})},decreaseGridDensity:function(){o.setSpacing(2*o.getSpacing()),o.getLayer().draw()},increaseGridDensity:function(){o.setSpacing(Math.max(5,o.getSpacing()/2)),o.getLayer().draw()},toDataURL:k.toDataURL.bind(k),toJSON:function(){return JSON.stringify(p.toObject().children)},select:function(a){g(a,h.isComponentResizable({component:a}))}}}}}]);